// Pure functions extracted for testing (without Obsidian dependencies)
// Constants
export const DEDUPLICATE = true;
export const SORT = false;
export const REVERSE_CHRONO = true;
export const OVERRIDE_WITH_NEWER_CHECKED = true;
export const GROUP_BY_DATE = true;
const CHECKED_TASK_REGEX = /^[\t >-]*[-*+]\s+\[[xX]\]\s.+$/;
const UNCHECKED_TASK_REGEX = /^[\t >-]*[-*+]\s+\[ \]\s.+$/;
// Pure functions for data manipulation
export const normalizeTaskText = (line) => {
    const m = line.match(/^[\t >-]*[-*+]\s+\[[ xX]\]\s+(.*)$/);
    return m ? m[1].trim() : null;
};
export const extractCheckedTasks = (fileContents) => {
    const filesNewestToOldest = [...fileContents].sort((a, b) => b.fileName.localeCompare(a.fileName));
    const newerChecked = new Set();
    for (const { lines } of filesNewestToOldest) {
        for (const line of lines) {
            if (CHECKED_TASK_REGEX.test(line)) {
                const txt = normalizeTaskText(line);
                if (txt)
                    newerChecked.add(txt);
            }
        }
    }
    return newerChecked;
};
export const processTasksWithOverrides = (fileContents, newerChecked, reverseChronological = true) => {
    const tasksByDate = {};
    let allTasks = [];
    const sortedFiles = reverseChronological
        ? [...fileContents].sort((a, b) => b.fileName.localeCompare(a.fileName))
        : [...fileContents].sort((a, b) => a.fileName.localeCompare(b.fileName));
    for (const { fileName, lines } of sortedFiles) {
        const included = [];
        for (const line of lines) {
            if (UNCHECKED_TASK_REGEX.test(line)) {
                const txt = normalizeTaskText(line);
                if (txt &&
                    OVERRIDE_WITH_NEWER_CHECKED &&
                    newerChecked.has(txt) &&
                    // Ensure the *current* file isn't the one providing the checked instance
                    !lines.some((l) => CHECKED_TASK_REGEX.test(l) && normalizeTaskText(l) === txt)) {
                    continue; // suppressed by newer checked task
                }
                included.push(line);
                allTasks.push(line);
            }
        }
        if (included.length) {
            tasksByDate[fileName] = included;
        }
    }
    return { tasksByDate, allTasks };
};
export const createTaskOwnershipMap = (tasksByDate) => {
    const taskOwnership = new Map();
    if (!DEDUPLICATE || !GROUP_BY_DATE) {
        return taskOwnership;
    }
    // Process dates from newest to oldest to find most recent occurrence of each task
    const dates = Object.keys(tasksByDate).sort((a, b) => b.localeCompare(a)); // newest first
    for (const date of dates) {
        for (const task of tasksByDate[date]) {
            const normalizedTask = normalizeTaskText(task);
            if (normalizedTask && !taskOwnership.has(normalizedTask)) {
                // First time seeing this task (processing newest to oldest), so this date owns it
                taskOwnership.set(normalizedTask, date);
            }
        }
    }
    return taskOwnership;
};
export const buildFinalTasksByDate = (tasksByDate, taskOwnership, shouldSort = false) => {
    const finalTasksByDate = {};
    let allFinalTasks = [];
    if (GROUP_BY_DATE) {
        for (const date of Object.keys(tasksByDate)) {
            const dateTasks = tasksByDate[date].filter((task) => {
                if (!DEDUPLICATE)
                    return true;
                const normalizedTask = normalizeTaskText(task);
                if (!normalizedTask)
                    return true;
                // Only include task if this date owns it
                return taskOwnership.get(normalizedTask) === date;
            });
            if (dateTasks.length) {
                finalTasksByDate[date] = shouldSort
                    ? dateTasks.slice().sort((a, b) => a.localeCompare(b, undefined, { sensitivity: "base" }))
                    : dateTasks;
                allFinalTasks.push(...finalTasksByDate[date]);
            }
        }
    }
    return { finalTasksByDate, allFinalTasks };
};
export const buildNonGroupedTasks = (allTasks, shouldSort = false) => {
    let finalTasks = allTasks;
    if (DEDUPLICATE) {
        const seen = new Set();
        finalTasks = [];
        for (const t of allTasks) {
            const key = t.trim();
            if (!seen.has(key)) {
                seen.add(key);
                finalTasks.push(t);
            }
        }
    }
    if (shouldSort) {
        finalTasks = finalTasks
            .slice()
            .sort((a, b) => a.localeCompare(b, undefined, { sensitivity: "base" }));
    }
    return finalTasks;
};
export const generateOutput = (finalTasksByDate, allFinalTasks, reverseChronological = true) => {
    let output = "### Unchecked Tasks\n\n";
    if (GROUP_BY_DATE) {
        // Insert grouped by date (sorted chronologically)
        const dates = Object.keys(finalTasksByDate).sort((a, b) => a.localeCompare(b));
        if (reverseChronological) {
            dates.reverse();
        }
        for (const date of dates) {
            if (finalTasksByDate[date].length) {
                output += `#### ${date}\n`;
                output += finalTasksByDate[date].join("\n") + "\n\n";
            }
        }
    }
    else {
        output += allFinalTasks.join("\n") + "\n";
    }
    return output;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZnVuY3Rpb25zLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vZnVuY3Rpb25zLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLHVFQUF1RTtBQWF2RSxZQUFZO0FBQ1osTUFBTSxDQUFDLE1BQU0sV0FBVyxHQUFHLElBQUksQ0FBQztBQUNoQyxNQUFNLENBQUMsTUFBTSxJQUFJLEdBQUcsS0FBSyxDQUFDO0FBQzFCLE1BQU0sQ0FBQyxNQUFNLGNBQWMsR0FBRyxJQUFJLENBQUM7QUFDbkMsTUFBTSxDQUFDLE1BQU0sMkJBQTJCLEdBQUcsSUFBSSxDQUFDO0FBQ2hELE1BQU0sQ0FBQyxNQUFNLGFBQWEsR0FBRyxJQUFJLENBQUM7QUFFbEMsTUFBTSxrQkFBa0IsR0FBRyxnQ0FBZ0MsQ0FBQztBQUM1RCxNQUFNLG9CQUFvQixHQUFHLDZCQUE2QixDQUFDO0FBRTNELHVDQUF1QztBQUN2QyxNQUFNLENBQUMsTUFBTSxpQkFBaUIsR0FBRyxDQUFDLElBQVksRUFBaUIsRUFBRTtJQUMvRCxNQUFNLENBQUMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLG9DQUFvQyxDQUFDLENBQUM7SUFDM0QsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDO0FBQ2hDLENBQUMsQ0FBQztBQUVGLE1BQU0sQ0FBQyxNQUFNLG1CQUFtQixHQUFHLENBQUMsWUFBMkIsRUFBZSxFQUFFO0lBQzlFLE1BQU0sbUJBQW1CLEdBQUcsQ0FBQyxHQUFHLFlBQVksQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUMxRCxDQUFDLENBQUMsUUFBUSxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQ3JDLENBQUM7SUFDRixNQUFNLFlBQVksR0FBRyxJQUFJLEdBQUcsRUFBVSxDQUFDO0lBRXZDLEtBQUssTUFBTSxF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QUFDLENBQUMsQ0FBQztLQUMzRTtJQUVELE9BQU8sVUFBVSxDQUFDO0FBQ3BCLENBQUMsQ0FBQztBQUVGLE1BQU0sQ0FBQyxNQUFNLGNBQWMsR0FBRyxDQUM1QixnQkFBMEMsRUFDMUMsYUFBdUIsRUFDdkIsdUJBQWdDLElBQUksRUFDNUIsRUFBRTtJQUNWLElBQUksTUFBTSxHQUFHLHlCQUF5QixDQUFDO0lBRXZDLElBQUksYUFBYSxFQUFFO1FBQ2pCLGtEQUFrRDtRQUNsRCxNQUFNLEtBQUssR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQy9FLElBQUksb0JBQW9CLEVBQUU7WUFDeEIsS0FBSyxDQUFDLE9BQU8sRUFBRSxDQUFDO1NBQ2pCO1FBQ0QsS0FBSyxNQUFNLElBQUksSUFBSSxLQUFLLEVBQUU7WUFDeEIsSUFBSSxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsQ0FBQyxNQUFNLEVBQUU7Z0JBQ2pDLE1BQU0sSUFBSSxRQUFRLElBQUksSUFBSSxDQUFDO2dCQUMzQixNQUFNLElBQUksZ0JBQWdCLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLE1BQU0sQ0FBQzthQUN0RDtTQUNGO0tBQ0Y7U0FBTTtRQUNMLE1BQU0sSUFBSSxhQUFhLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQztLQUMzQztJQUVELE9BQU8sTUFBTSxDQUFDO0FBQ2hCLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8vIFB1cmUgZnVuY3Rpb25zIGV4dHJhY3RlZCBmb3IgdGVzdGluZyAod2l0aG91dCBPYnNpZGlhbiBkZXBlbmRlbmNpZXMpXG5cbi8vIFR5cGVzIGZvciBkYXRhIHByb2Nlc3NpbmdcbmV4cG9ydCBpbnRlcmZhY2UgRmlsZUNvbnRlbnQge1xuICBmaWxlTmFtZTogc3RyaW5nO1xuICBsaW5lczogc3RyaW5nW107XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgUHJvY2Vzc2VkVGFza3Mge1xuICB0YXNrc0J5RGF0ZTogUmVjb3JkPHN0cmluZywgc3RyaW5nW10+O1xuICBhbGxUYXNrczogc3RyaW5nW107XG59XG5cbi8vIENvbnN0YW50c1xuZXhwb3J0IGNvbnN0IERFRFVQTElDQVRFID0gdHJ1ZTtcbmV4cG9ydCBjb25zdCBTT1JUID0gZmFsc2U7XG5leHBvcnQgY29uc3QgUkVWRVJTRV9DSFJPTk8gPSB0cnVlO1xuZXhwb3J0IGNvbnN0IE9WRVJSSURFX1dJVEhfTkVXRVJfQ0hFQ0tFRCA9IHRydWU7XG5leHBvcnQgY29uc3QgR1JPVVBfQllfREFURSA9IHRydWU7XG5cbmNvbnN0IENIRUNLRURfVEFTS19SRUdFWCA9IC9eW1xcdCA+LV0qWy0qK11cXHMrXFxbW3hYXVxcXVxccy4rJC87XG5jb25zdCBVTkNIRUNLRURfVEFTS19SRUdFWCA9IC9eW1xcdCA+LV0qWy0qK11cXHMrXFxbIFxcXVxccy4rJC87XG5cbi8vIFB1cmUgZnVuY3Rpb25zIGZvciBkYXRhIG1hbmlwdWxhdGlvblxuZXhwb3J0IGNvbnN0IG5vcm1hbGl6ZVRhc2tUZXh0ID0gKGxpbmU6IHN0cmluZyk6IHN0cmluZyB8IG51bGwgPT4ge1xuICBjb25zdCBtID0gbGluZS5tYXRjaCgvXltcXHQgPi1dKlstKitdXFxzK1xcW1sgeFhdXFxdXFxzKyguKikkLyk7XG4gIHJldHVybiBtID8gbVsxXS50cmltKCkgOiBudWxsO1xufTtcblxuZXhwb3J0IGNvbnN0IGV4dHJhY3RDaGVja2VkVGFza3MgPSAoZmlsZUNvbnRlbnRzOiBGaWxlQ29udGVudFtdKTogU2V0PHN0cmluZz4gPT4ge1xuICBjb25zdCBmaWxlc05ld2VzdFRvT2xkZXN0ID0gWy4uLmZpbGVDb250ZW50c10uc29ydCgoYSwgYikgPT5cbiAgICBiLmZpbGVOYW1lLmxvY2FsZUNvbXBhcmUoYS5maWxlTmFtZSlcbiAgKTtcbiAgY29uc3QgbmV3ZXJDaGVja2VkID0gbmV3IFNldDxzdHJpbmc+KCk7XG4gIFxuICBmb3IgKGNvbnN0IHsgbGluZXMgfSBvZiBmaWxlc05ld2VzdFRvT2xkZXN0KSB7XG4gICAgZm9yIChjb25zdCBsaW5lIG9mIGxpbmVzKSB7XG4gICAgICBpZiAoQ0hFQ0tFRF9UQVNLX1JFR0VYLnRlc3QobGluZSkpIHtcbiAgICAgICAgY29uc3QgdHh0ID0gbm9ybWFsaXplVGFza1RleHQobGluZSk7XG4gICAgICAgIGlmICh0eHQpIG5ld2VyQ2hlY2tlZC5hZGQodHh0KTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgXG4gIHJldHVybiBuZXdlckNoZWNrZWQ7XG59O1xuXG5leHBvcnQgY29uc3QgcHJvY2Vzc1Rhc2tzV2l0aE92ZXJyaWRlcyA9IChcbiAgZmlsZUNvbnRlbnRzOiBGaWxlQ29udGVudFtdLFxuICBuZXdlckNoZWNrZWQ6IFNldDxzdHJpbmc+LFxuICByZXZlcnNlQ2hyb25vbG9naWNhbDogYm9vbGVhbiA9IHRydWVcbik6IFByb2Nlc3NlZFRhc2tzID0+IHtcbiAgY29uc3QgdGFza3NCeURhdGU6IFJlY29yZDxzdHJpbmcsIHN0cmluZ1tdPiA9IHt9O1xuICBsZXQgYWxsVGFza3M6IHN0cmluZ1tdID0gW107XG5cbiAgY29uc3Qgc29ydGVkRmlsZXMgPSByZXZlcnNlQ2hyb25vbG9naWNhbFxuICAgID8gWy4uLmZpbGVDb250ZW50c10uc29ydCgoYSwgYikgPT4gYi5maWxlTmFtZS5sb2NhbGVDb21wYXJlKGEuZmlsZU5hbWUpKVxuICAgIDogWy4uLmZpbGVDb250ZW50c10uc29ydCgoYSwgYikgPT4gYS5maWxlTmFtZS5sb2NhbGVDb21wYXJlKGIuZmlsZU5hbWUpKTtcblxuICBmb3IgKGNvbnN0IHsgZmlsZU5hbWUsIGxpbmVzIH0gb2Ygc29ydGVkRmlsZXMpIHtcbiAgICBjb25zdCBpbmNsdWRlZDogc3RyaW5nW10gPSBbXTtcbiAgICBmb3IgKGNvbnN0IGxpbmUgb2YgbGluZXMpIHtcbiAgICAgIGlmIChVTkNIRUNLRURfVEFTS19SRUdFWC50ZXN0KGxpbmUpKSB7XG4gICAgICAgIGNvbnN0IHR4dCA9IG5vcm1hbGl6ZVRhc2tUZXh0KGxpbmUpO1xuICAgICAgICBpZiAoXG4gICAgICAgICAgdHh0ICYmXG4gICAgICAgICAgT1ZFUlJJREVfV0lUSF9ORVdFUl9DSEVDS0VEICYmXG4gICAgICAgICAgbmV3ZXJDaGVja2VkLmhhcyh0eHQpICYmXG4gICAgICAgICAgLy8gRW5zdXJlIHRoZSAqY3VycmVudCogZmlsZSBpc24ndCB0aGUgb25lIHByb3ZpZGluZyB0aGUgY2hlY2tlZCBpbnN0YW5jZVxuICAgICAgICAgICFsaW5lcy5zb21lKFxuICAgICAgICAgICAgKGwpID0+IENIRUNLRURfVEFTS19SRUdFWC50ZXN0KGwpICYmIG5vcm1hbGl6ZVRhc2tUZXh0KGwpID09PSB0eHRcbiAgICAgICAgICApXG4gICAgICAgICkge1xuICAgICAgICAgIGNvbnRpbnVlOyAvLyBzdXBwcmVzc2VkIGJ5IG5ld2VyIGNoZWNrZWQgdGFza1xuICAgICAgICB9XG4gICAgICAgIGluY2x1ZGVkLnB1c2gobGluZSk7XG4gICAgICAgIGFsbFRhc2tzLnB1c2gobGluZSk7XG4gICAgICB9XG4gICAgfVxuICAgIGlmIChpbmNsdWRlZC5sZW5ndGgpIHtcbiAgICAgIHRhc2tzQnlEYXRlW2ZpbGVOYW1lXSA9IGluY2x1ZGVkO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiB7IHRhc2tzQnlEYXRlLCBhbGxUYXNrcyB9O1xufTtcblxuZXhwb3J0IGNvbnN0IGNyZWF0ZVRhc2tPd25lcnNoaXBNYXAgPSAodGFza3NCeURhdGU6IFJlY29yZDxzdHJpbmcsIHN0cmluZ1tdPik6IE1hcDxzdHJpbmcsIHN0cmluZz4gPT4ge1xuICBjb25zdCB0YXNrT3duZXJzaGlwID0gbmV3IE1hcDxzdHJpbmcsIHN0cmluZz4oKTtcbiAgXG4gIGlmICghREVEVVBMSUNBVEUgfHwgIUdST1VQX0JZX0RBVEUpIHtcbiAgICByZXR1cm4gdGFza093bmVyc2hpcDtcbiAgfVxuXG4gIC8vIFByb2Nlc3MgZGF0ZXMgZnJvbSBuZXdlc3QgdG8gb2xkZXN0IHRvIGZpbmQgbW9zdCByZWNlbnQgb2NjdXJyZW5jZSBvZiBlYWNoIHRhc2tcbiAgY29uc3QgZGF0ZXMgPSBPYmplY3Qua2V5cyh0YXNrc0J5RGF0ZSkuc29ydCgoYSwgYikgPT4gYi5sb2NhbGVDb21wYXJlKGEpKTsgLy8gbmV3ZXN0IGZpcnN0XG4gIFxuICBmb3IgKGNvbnN0IGRhdGUgb2YgZGF0ZXMpIHtcbiAgICBmb3IgKGNvbnN0IHRhc2sgb2YgdGFza3NCeURhdGVbZGF0ZV0pIHtcbiAgICAgIGNvbnN0IG5vcm1hbGl6ZWRUYXNrID0gbm9ybWFsaXplVGFza1RleHQodGFzayk7XG4gICAgICBpZiAobm9ybWFsaXplZFRhc2sgJiYgIXRhc2tPd25lcnNoaXAuaGFzKG5vcm1hbGl6ZWRUYXNrKSkge1xuICAgICAgICAvLyBGaXJzdCB0aW1lIHNlZWluZyB0aGlzIHRhc2sgKHByb2Nlc3NpbmcgbmV3ZXN0IHRvIG9sZGVzdCksIHNvIHRoaXMgZGF0ZSBvd25zIGl0XG4gICAgICAgIHRhc2tPd25lcnNoaXAuc2V0KG5vcm1hbGl6ZWRUYXNrLCBkYXRlKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgXG4gIHJldHVybiB0YXNrT3duZXJzaGlwO1xufTtcblxuZXhwb3J0IGNvbnN0IGJ1aWxkRmluYWxUYXNrc0J5RGF0ZSA9IChcbiAgdGFza3NCeURhdGU6IFJlY29yZDxzdHJpbmcsIHN0cmluZ1tdPixcbiAgdGFza093bmVyc2hpcDogTWFwPHN0cmluZywgc3RyaW5nPixcbiAgc2hvdWxkU29ydDogYm9vbGVhbiA9IGZhbHNlXG4pOiB7IGZpbmFsVGFza3NCeURhdGU6IFJlY29yZDxzdHJpbmcsIHN0cmluZ1tdPjsgYWxsRmluYWxUYXNrczogc3RyaW5nW10gfSA9PiB7XG4gIGNvbnN0IGZpbmFsVGFza3NCeURhdGU6IFJlY29yZDxzdHJpbmcsIHN0cmluZ1tdPiA9IHt9O1xuICBsZXQgYWxsRmluYWxUYXNrczogc3RyaW5nW10gPSBbXTtcblxuICBpZiAoR1JPVVBfQllfREFURSkge1xuICAgIGZvciAoY29uc3QgZGF0ZSBvZiBPYmplY3Qua2V5cyh0YXNrc0J5RGF0ZSkpIHtcbiAgICAgIGNvbnN0IGRhdGVUYXNrcyA9IHRhc2tzQnlEYXRlW2RhdGVdLmZpbHRlcigodGFzaykgPT4ge1xuICAgICAgICBpZiAoIURFRFVQTElDQVRFKSByZXR1cm4gdHJ1ZTtcbiAgICAgICAgXG4gICAgICAgIGNvbnN0IG5vcm1hbGl6ZWRUYXNrID0gbm9ybWFsaXplVGFza1RleHQodGFzayk7XG4gICAgICAgIGlmICghbm9ybWFsaXplZFRhc2spIHJldHVybiB0cnVlO1xuICAgICAgICBcbiAgICAgICAgLy8gT25seSBpbmNsdWRlIHRhc2sgaWYgdGhpcyBkYXRlIG93bnMgaXRcbiAgICAgICAgcmV0dXJuIHRhc2tPd25lcnNoaXAuZ2V0KG5vcm1hbGl6ZWRUYXNrKSA9PT0gZGF0ZTtcbiAgICAgIH0pO1xuICAgICAgXG4gICAgICBpZiAoZGF0ZVRhc2tzLmxlbmd0aCkge1xuICAgICAgICBmaW5hbFRhc2tzQnlEYXRlW2RhdGVdID0gc2hvdWxkU29ydCBcbiAgICAgICAgICA/IGRhdGVUYXNrcy5zbGljZSgpLnNvcnQoKGEsIGIpID0+IGEubG9jYWxlQ29tcGFyZShiLCB1bmRlZmluZWQsIHsgc2Vuc2l0aXZpdHk6IFwiYmFzZVwiIH0pKVxuICAgICAgICAgIDogZGF0ZVRhc2tzO1xuICAgICAgICBhbGxGaW5hbFRhc2tzLnB1c2goLi4uZmluYWxUYXNrc0J5RGF0ZVtkYXRlXSk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIHsgZmluYWxUYXNrc0J5RGF0ZSwgYWxsRmluYWxUYXNrcyB9O1xufTtcblxuZXhwb3J0IGNvbnN0IGJ1aWxkTm9uR3JvdXBlZFRhc2tzID0gKFxuICBhbGxUYXNrczogc3RyaW5nW10sXG4gIHNob3VsZFNvcnQ6IGJvb2xlYW4gPSBmYWxzZVxuKTogc3RyaW5nW10gPT4ge1xuICBsZXQgZmluYWxUYXNrcyA9IGFsbFRhc2tzO1xuICBcbiAgaWYgKERFRFVQTElDQVRFKSB7XG4gICAgY29uc3Qgc2VlbiA9IG5ldyBTZXQ8c3RyaW5nPigpO1xuICAgIGZpbmFsVGFza3MgPSBbXTtcbiAgICBmb3IgKGNvbnN0IHQgb2YgYWxsVGFza3MpIHtcbiAgICAgIGNvbnN0IGtleSA9IHQudHJpbSgpO1xuICAgICAgaWYgKCFzZWVuLmhhcyhrZXkpKSB7XG4gICAgICAgIHNlZW4uYWRkKGtleSk7XG4gICAgICAgIGZpbmFsVGFza3MucHVzaCh0KTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgXG4gIGlmIChzaG91bGRTb3J0KSB7XG4gICAgZmluYWxUYXNrcyA9IGZpbmFsVGFza3NcbiAgICAgIC5zbGljZSgpXG4gICAgICAuc29ydCgoYSwgYikgPT4gYS5sb2NhbGVDb21wYXJlKGIsIHVuZGVmaW5lZCwgeyBzZW5zaXRpdml0eTogXCJiYXNlXCIgfSkpO1xuICB9XG4gIFxuICByZXR1cm4gZmluYWxUYXNrcztcbn07XG5cbmV4cG9ydCBjb25zdCBnZW5lcmF0ZU91dHB1dCA9IChcbiAgZmluYWxUYXNrc0J5RGF0ZTogUmVjb3JkPHN0cmluZywgc3RyaW5nW10+LFxuICBhbGxGaW5hbFRhc2tzOiBzdHJpbmdbXSxcbiAgcmV2ZXJzZUNocm9ub2xvZ2ljYWw6IGJvb2xlYW4gPSB0cnVlXG4pOiBzdHJpbmcgPT4ge1xuICBsZXQgb3V0cHV0ID0gXCIjIyMgVW5jaGVja2VkIFRhc2tzXFxuXFxuXCI7XG4gIFxuICBpZiAoR1JPVVBfQllfREFURSkge1xuICAgIC8vIEluc2VydCBncm91cGVkIGJ5IGRhdGUgKHNvcnRlZCBjaHJvbm9sb2dpY2FsbHkpXG4gICAgY29uc3QgZGF0ZXMgPSBPYmplY3Qua2V5cyhmaW5hbFRhc2tzQnlEYXRlKS5zb3J0KChhLCBiKSA9PiBhLmxvY2FsZUNvbXBhcmUoYikpO1xuICAgIGlmIChyZXZlcnNlQ2hyb25vbG9naWNhbCkge1xuICAgICAgZGF0ZXMucmV2ZXJzZSgpO1xuICAgIH1cbiAgICBmb3IgKGNvbnN0IGRhdGUgb2YgZGF0ZXMpIHtcbiAgICAgIGlmIChmaW5hbFRhc2tzQnlEYXRlW2RhdGVdLmxlbmd0aCkge1xuICAgICAgICBvdXRwdXQgKz0gYCMjIyMgJHtkYXRlfVxcbmA7XG4gICAgICAgIG91dHB1dCArPSBmaW5hbFRhc2tzQnlEYXRlW2RhdGVdLmpvaW4oXCJcXG5cIikgKyBcIlxcblxcblwiO1xuICAgICAgfVxuICAgIH1cbiAgfSBlbHNlIHtcbiAgICBvdXRwdXQgKz0gYWxsRmluYWxUYXNrcy5qb2luKFwiXFxuXCIpICsgXCJcXG5cIjtcbiAgfVxuICBcbiAgcmV0dXJuIG91dHB1dDtcbn07Il19